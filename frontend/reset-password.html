<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password - HomeService</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/auth.css">
</head>

<body>
    <nav class="navbar">
        <div class="container navbar-main">
            <a href="index.html" class="logo" style="text-decoration: none; color: inherit;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                    <polyline points="9 22 9 12 15 12 15 22"></polyline>
                </svg>
                HomeService
            </a>

            <!-- Search Bar in Header -->
            <div class="navbar-search">
                <div class="search-wrapper-navbar">
                    <svg class="search-icon-navbar" xmlns="http://www.w3.org/2000/svg" width="18" height="18"
                        viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.35-4.35"></path>
                    </svg>
                    <input type="text" id="navServiceSearch" class="search-input-navbar"
                        placeholder="Search services..." autocomplete="off">
                    <div id="navSearchAutocomplete" class="search-autocomplete-navbar"></div>
                </div>
            </div>

            <ul class="nav-links">
                <li><a href="index.html">Home</a></li>
                <li><a href="index.html#services">Services</a></li>
                <li id="authLinks">
                    <a href="login.html" class="nav-btn">Login</a>
                    <a href="register.html" class="nav-btn nav-btn-primary">Sign Up</a>
                </li>
                <li id="userLinks" style="display: none;" class="user-nav-links">
                    <span id="userGreeting" class="user-greeting"></span>
                    <a href="#" id="dashboardLink" class="nav-btn nav-btn-primary">Dashboard</a>
                    <a href="#" id="logoutLink" class="nav-btn nav-logout" onclick="handleLogout(event)">Logout</a>
                </li>
            </ul>
        </div>
    </nav>

    <div class="auth-container">
        <div class="auth-box">
            <div id="tokenCheck" style="text-align: center;">
                <h2>Verifying Reset Token...</h2>
                <p class="auth-subtitle">Please wait while we verify your reset link</p>
                <div
                    style="margin: 30px auto; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #2563eb; border-radius: 50%; animation: spin 1s linear infinite;">
                </div>
            </div>

            <div id="resetForm" style="display: none;">
                <h2>Reset Your Password</h2>
                <p class="auth-subtitle">Enter your new password below</p>

                <form id="passwordResetForm" class="auth-form">
                    <div class="form-group">
                        <label for="password">New Password</label>
                        <input type="password" id="password" name="password" required minlength="6"
                            placeholder="Enter new password (min 6 characters)">
                    </div>

                    <div class="form-group">
                        <label for="confirmPassword">Confirm Password</label>
                        <input type="password" id="confirmPassword" name="confirmPassword" required minlength="6"
                            placeholder="Confirm your new password">
                    </div>

                    <div id="errorMessage" class="error-message"></div>
                    <div id="successMessage" class="success-message"></div>

                    <button type="submit" class="btn btn-primary btn-block">Reset Password</button>
                </form>

                <div class="auth-footer">
                    Remember your password? <a href="login.html">Login here</a>
                </div>
            </div>

            <div id="invalidToken" style="display: none; text-align: center;">
                <h2>Invalid or Expired Link</h2>
                <p class="auth-subtitle" style="color: #dc2626; margin-bottom: 20px;">This password reset link is
                    invalid or has expired.</p>
                <a href="forgot-password.html" class="btn btn-primary"
                    style="display: inline-block; text-decoration: none;">Request New Link</a>
                <div class="auth-footer">
                    <a href="login.html">Back to Login</a>
                </div>
            </div>
        </div>
    </div>

    <style>
        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>

    <script src="js/main.js"></script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');

        if (!token) {
            document.getElementById('tokenCheck').style.display = 'none';
            document.getElementById('invalidToken').style.display = 'block';
        } else {
            verifyToken(token);
        }

        function verifyToken(token) {
            fetch('../backend/api/verify-reset-token.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ token: token })
            })
                .then(response => response.json())
                .then(data => {
                    document.getElementById('tokenCheck').style.display = 'none';

                    if (data.success) {
                        document.getElementById('resetForm').style.display = 'block';
                    } else {
                        document.getElementById('invalidToken').style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error('Token verification error:', error);
                    document.getElementById('tokenCheck').style.display = 'none';
                    document.getElementById('invalidToken').style.display = 'block';
                });
        }

        document.getElementById('passwordResetForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const errorMessage = document.getElementById('errorMessage');
            const successMessage = document.getElementById('successMessage');
            const button = document.querySelector('button[type="submit"]');

            errorMessage.textContent = '';
            errorMessage.classList.remove('show');
            successMessage.textContent = '';
            successMessage.classList.remove('show');

            if (password !== confirmPassword) {
                errorMessage.textContent = 'Passwords do not match.';
                errorMessage.classList.add('show');
                return;
            }

            if (password.length < 6) {
                errorMessage.textContent = 'Password must be at least 6 characters long.';
                errorMessage.classList.add('show');
                return;
            }

            button.disabled = true;
            button.textContent = 'Resetting...';

            fetch('../backend/api/reset-password.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    token: token,
                    password: password
                })
            })
                .then(response => response.json())
                .then(data => {
                    button.disabled = false;
                    button.textContent = 'Reset Password';

                    if (data.success) {
                        successMessage.textContent = 'Password reset successfully! Redirecting to login...';
                        successMessage.classList.add('show');
                        setTimeout(() => {
                            window.location.href = 'login.html';
                        }, 2000);
                    } else {
                        errorMessage.textContent = data.message || 'Failed to reset password.';
                        errorMessage.classList.add('show');
                    }
                })
                .catch(error => {
                    console.error('Reset error:', error);
                    button.disabled = false;
                    button.textContent = 'Reset Password';
                    errorMessage.textContent = 'An error occurred. Please try again.';
                    errorMessage.classList.add('show');
                });
        });
    </script>
</body>

</html>